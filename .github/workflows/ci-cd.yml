name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION:     ap-south-1
  ECR_REPOSITORY: pulseops-incident-logger
  IMAGE_TAG:      ${{ github.sha }}

jobs:

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install linting tools
        run: pip install flake8
      - name: Run flake8
        run: flake8 app/ --max-line-length=120 --ignore=E501,W292,E221,E251,E241,F401,E302

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER:     postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB:       testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/testdb
          PYTHONPATH: ${{ github.workspace }}
        run: pytest tests/ -v

  build:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    outputs:
      image: ${{ steps.build-image.outputs.image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Build, tag and push image to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          ECR_REGISTRY:   ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          IMAGE_TAG:      ${{ env.IMAGE_TAG }}
          AWS_REGION:     ${{ env.AWS_REGION }}
        with:
          host:        ${{ secrets.EC2_HOST }}
          username:    ${{ secrets.EC2_USERNAME }}
          key:         ${{ secrets.EC2_SSH_KEY }}
          envs:        ECR_REGISTRY,ECR_REPOSITORY,IMAGE_TAG,AWS_REGION
          script: |
            cd /home/ubuntu/pulseops-incident-logger
            GIT_SSH_COMMAND='ssh -i ~/.ssh/deploy_key' git pull origin main
            aws ecr get-login-password --region $AWS_REGION | \
              docker login --username AWS --password-stdin $ECR_REGISTRY
            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            PREVIOUS_TAG=$(docker inspect incident-logger \
              --format='{{index .Config.Labels "image.tag"}}' 2>/dev/null)
            if [ -z "$PREVIOUS_TAG" ]; then
              PREVIOUS_TAG=$IMAGE_TAG
            fi
            export IMAGE=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            export IMAGE_TAG=$IMAGE_TAG
            docker-compose up -d 
            sleep 30
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health/ready)
            if [ "$HTTP_STATUS" == "200" ]; then
              echo "Deploy successful"
            else
              echo "Deploy failed â€” health check returned $HTTP_STATUS"
              echo "Rolling back..."
              export IMAGE=$ECR_REGISTRY/$ECR_REPOSITORY:$PREVIOUS_TAG
              export IMAGE_TAG=$PREVIOUS_TAG
              docker-compose up -d 
              exit 1
            fi
            


  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "Deployment successful"
            echo "Commit: ${{ github.sha }}"
          else
            echo "Deployment failed"
            echo "Commit: ${{ github.sha }}"
          fi