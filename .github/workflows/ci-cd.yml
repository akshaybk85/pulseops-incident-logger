name: CI/CD Pipeline â€” Incident Logger

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION:     ap-south-1
  ECR_REPOSITORY: pulseops-incident-logger
  IMAGE_TAG:      ${{ github.sha }}    # unique tag per commit

jobs:

# â”€â”€ JOB 1: LINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linting tools
        run: pip install flake8

      - name: Run flake8
          run: flake8 app/ --max-line-length=120 --ignore=E501,W292,E221,E251,E241,F401,E302
        


# â”€â”€ JOB 2: TEST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint                        # only runs if lint passes

    services:                          # spin up a real PostgreSQL for tests
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER:     postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB:       testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/testdb
        run: pytest tests/ -v


# â”€â”€ JOB 3: BUILD & PUSH TO ECR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: test                        # only runs if tests pass
    if: github.ref == 'refs/heads/main'  # only on main branch, not PRs

    outputs:
      image: ${{ steps.build-image.outputs.image }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag and push image to ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # Build the Docker image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .

          # Push both tags â€” commit SHA for traceability, latest for convenience
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

          # Pass image URI to deploy job
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT


# â”€â”€ JOB 4: DEPLOY TO EC2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build                       # only runs if build passes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          ECR_REGISTRY:   ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          IMAGE_TAG:      ${{ env.IMAGE_TAG }}
          AWS_REGION:     ${{ env.AWS_REGION }}
        with:
          host:        ${{ secrets.EC2_HOST }}
          username:    ${{ secrets.EC2_USERNAME }}
          key:         ${{ secrets.EC2_SSH_KEY }}
          envs:        ECR_REGISTRY,ECR_REPOSITORY,IMAGE_TAG,AWS_REGION
          script: |
            # Login to ECR from EC2
            aws ecr get-login-password --region $AWS_REGION | \
              docker login --username AWS --password-stdin $ECR_REGISTRY

            # Pull the new image
            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

            # Store current image tag for rollback
            PREVIOUS_TAG=$(docker inspect incident-logger \
              --format='{{index .Config.Labels "image.tag"}}' 2>/dev/null || echo "latest")

            # Update image tag in environment
            export NEW_IMAGE=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

            # Navigate to project directory
            cd /home/ubuntu/pulseops-incident-logger


            # Update the image in docker-compose
            IMAGE=$NEW_IMAGE docker compose up -d --no-deps incident-logger

            # Wait for container to start
            sleep 10

            # Health check â€” readiness endpoint checks app + DB
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health/ready)

            if [ "$HTTP_STATUS" == "200" ]; then
              echo "âœ… Deploy successful â€” health check passed"
            else
              echo "âŒ Deploy failed â€” health check returned $HTTP_STATUS"
              echo "ğŸ”„ Rolling back to previous image..."

              # Rollback to previous image
              IMAGE=$ECR_REGISTRY/$ECR_REPOSITORY:$PREVIOUS_TAG \
                docker compose up -d --no-deps incident-logger

              exit 1
            fi


# â”€â”€ JOB 5: NOTIFY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()                       # runs even if deploy fails

    steps:
      - name: Notify deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment successful"
            echo "Commit: ${{ github.sha }}"
            echo "Author: ${{ github.actor }}"
          else
            echo "âŒ Deployment failed"
            echo "Commit: ${{ github.sha }}"
            echo "Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
